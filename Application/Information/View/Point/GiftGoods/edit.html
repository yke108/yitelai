<css href="__PUBLIC__/uploadify/uploadify.css"/>
<div class="row">
    <div class="col-sm-12 col-md-12">
        <h3 class="heading"><if condition="$Think.const.ACTION_NAME eq 'edit'">修改<else/>添加</if>礼品</h3>
			<form class="form-horizontal" method="post" enctype="multipart/form-data">
				<fieldset>
                	<div class="tabbable">
						<ul class="nav nav-tabs">
							<li class="active"><a href="#tab1" data-toggle="tab">基础信息</a></li>
                            <li><a href="#tab2" data-toggle="tab">商品相册</a></li>
							<!--<li><a href="#tab3" data-toggle="tab">活动规则</a></li>-->
							<!--<li><a href="#tab4" data-toggle="tab">商品介绍</a></li>-->
							<!--<li><a href="#tab5" data-toggle="tab">注意事项</a></li>-->
						</ul>
                        <div class="tab-content" id="cs-tab-content">
                        	<div class="tab-pane active" id="tab1">
                            	<div class="form-group">
                                    <label class="control-label col-sm-1">兑换商品名称</label>
                                    <div class="col-sm-8">
                                        <input name="name" class="input-xlarge form-control" type="text" value="{$info.name}">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="control-label col-sm-1">兑换所需积分</label>
                                    <div class="col-sm-8">
                                        <input name="point" class="input-xlarge form-control" type="text" value="{$info.point|default=1}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-sm-1">库存</label>
                                    <div class="col-sm-8">
                                        <input name="stock" class="input-xlarge form-control" type="text" value="{$info.stock|default=0}">
                                    </div>
                                </div>
                                            
                                <div class="form-group">
                                    <label for="u_fname" class="control-label col-sm-1">开始时间</label>
                                    <div class="col-sm-3 col-md-3">
                                        <input class="form-control hy_dp "  type="text" name="start_time" value="<if condition='$info.start_time neq ""'>{$info.start_time|date='Y-m-d',###}<else/>{:date('Y-m-d',NOW_TIME)}</if>">
                                        <span class="help-block">请选择开始时间</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="u_fname" class="control-label col-sm-1">结束时间</label>
                                    <div class="col-sm-3 col-md-3">
                                        <input class="form-control hy_dp "  type="text" name="end_time" value="<if condition='$info.end_time neq ""'>{$info.end_time|date='Y-m-d',###}<else/>{:date('Y-m-d',NOW_TIME)}</if>">
                                        <span class="help-block">请选择结束时间</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
									<label class="control-label col-sm-1">是否关闭</label>
									<div class="col-sm-8">
										<label class="radio-inline">
											<input value="1" name="is_close" {:m_checked($info[is_close], 1)} type="radio" class="refclick" ref="taxf">
											是
										</label>
										<label class="radio-inline">
											<input value="0" name="is_close" {:m_checked($info[is_close], 0)} type="radio" class="refclick" ref="taxf">
											否
										</label>
									</div>
								</div>
                                
                                <div class="form-group">
                                    <label class="control-label col-sm-1">排序</label>
                                    <div class="col-sm-4">
                                        <input name="sort_order" class="input-xlarge form-control" type="text" value="{$info.sort_order|default=1}">
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="tab2">
                            	<div class="row" style="min-height:150px;">
									<div class="col-sm-4">
										<div class="uploadify" id="file_img">
											<span id="uploadButton22" value="请先择主图" />
										</div>
									</div>
								</div>
								
								<div class="row" style="margin-top:12px;padding-top:12px;border-top:1px dashed #CCC;">
									<input id="mainpic" name="picture" type="hidden"/>
								</div>
								
								<!--<div class="row" style="min-height:150px;">
									<div class="col-sm-12">
										<div id="file_flash" class="uploadify">
											<input type="button" id="J_selectImage" value="批量上传" />
										</div>
									</div>
								</div>
								
								<div class="row" style="margin-top:12px;padding-top:12px;border-top:1px dashed #CCC;">
									<input id="flashpic" name="gallery" type="hidden"/>
								</div>-->
                            </div>
                            <!--<div class="tab-pane" id="tab3">
                            	<div class="form-group">
									<div class="col-sm-12">
										<textarea id="editor_id" class='editor_content' name="rule" style="width:100%;height:300px;" >
											 {$info['rule']}
										</textarea>
									</div>
								</div>
                            </div>-->
                            <!--<div class="tab-pane" id="tab4">
                            	<div class="form-group">
									<div class="col-sm-12">
										<textarea id="ueditor9" name="goods_introduce" style="width:100%;height:300px;">{$info['goods_introduce']}</textarea>
										
									</div>
								</div>
                            </div>-->
                            <!--<div class="tab-pane" id="tab5">
                            	<div class="form-group">
									<div class="col-sm-12">
										<textarea id="editor_id" class='editor_content' name="attentions" style="width:100%;height:300px;" >
											 {$info['attentions']}
										</textarea>
									</div>
								</div>
                            </div>-->                            
                        </div>
                    </div>
					
					
					<!--<div class="form-group">
						<label class="control-label col-sm-2">是否显示</label>
						<div class="col-sm-8">
							<label class="radio-inline">
								<input value="0" name="is_show" checked="checked" type="radio" <eq name="info.is_show" value="0">checked</eq> >
								是
							</label>
							<label class="radio-inline">
								<input value="1" name="is_show" type="radio" <eq name="info.is_show" value="1">checked</eq>>
								否
							</label>
						</div>
					</div>-->

					<div class="form-group">
						<div class="col-sm-8 col-sm-offset-2">
							<button class="btn btn-default" type="submit">确认并修改</button>
						</div>
					</div>
				</fieldset>
			</form>
    </div>
</div> 
<script>
var ue1 = UE.getEditor('ueditor9',{maximumWords:15000,initialFrameWidth:1000});
</script>
<script charset="utf-8" src="__PUBLIC__/editor/kindeditor.js"></script>
<script charset="utf-8" src="__PUBLIC__/editor/lang/zh_CN.js"></script>
<!--<script>
$(function(){
	
	KindEditor.ready(function(K) {
		window.editor = K.create('.editor_content', {uploadJson : '{:U("site/upload")}'});
	});
	$('#dp1').datepicker({format:"yyyy-mm-dd",startDate:'{$now_time|date="Y-m-d",###}'});
	$('#dp2').datepicker({format:"yyyy-mm-dd",startDate:'{$now_time|date="Y-m-d",###}'});
})
</script>
<script>
$("#sel_category").change(function(){
	var cat_id=$(this).val()
	$.ajax({
		type:'POST',
		url:"{:U('Category/getBrand')}",
		data:{'cat_id':cat_id},
		dataType:"json",
		success:function(res){
			var str='';
			for(i in res.list){
				str+="<option value='"+res.list[i].brand_id+"'>"+res.list[i].brand_name+"</option>"
			}
			$(".form-brand").html(str);
		}
	})
})
KindEditor.ready(function(K) {
	window.editor = K.create('#editor_id', {
		uploadJson : '{:U("site/upload")}',
		allowFileManager:true
	});
	
	
	var uploadbutton = K.uploadbutton({
		button : K('#uploadButton22')[0],
		fieldName : 'imgFile',
		url : '{:U("site/upload")}',
		afterUpload : function(data) {
			if (data.error === 0) {
				
				var url = K.formatUrl(data.url, 'absolute');
				
				url = $.trim(url).substring(6);
				//mainPicShow(url);
				mainPicShow(data.url);
			} else {
				alert(data.message);
			}
		},
		afterError : function(str) {
			alert('自定义错误信息: ' + str);
		}
	});
	uploadbutton.fileBox.change(function(e) {
		uploadbutton.submit();
	});
	K('.ke-upload-area').css({width:'100%', height:'100%'});
	
	var editor2 = K.editor({
		uploadJson : '{:U("site/upload")}',
		allowFileManager : true
	});
	K('#J_selectImage').click(function() {
		editor2.loadPlugin('multiimage', function() {
			editor2.plugin.multiImageDialog({
				clickFn : function(urlList) {
					K.each(urlList, function(i, data) {
						var url = K.formatUrl(data.url, 'absolute');
						//url = $.trim(url).substring(6);
						
						listPicShow(data.url);
					});
					editor2.hideDialog();
				}
			});
		});
	});
	
	//初始化显示图片
	<notempty name="info.picture">
	mainPicShow('{$info.picture}');
	</notempty>
	
	<volist name="info.gallery" id="vo">
	listPicShow('{$vo}');
	</volist>
});
</script>

<script type="text/javascript">  

function gresize(obj){
	var w = $(obj).width();
	var h = $(obj).height();
	if(w > h){
		$(obj).css({'height':'100%'});
	} else {
		$(obj).css({'width':'100%'});
	}
}

function listPicShow(data){
	//data = $.trim(data).substring(1);
	var fp_input = $('#flashpic');
	var fp_input_val = fp_input.val();
	if(fp_input_val.length < 1){
		fp_input_val = '#';
	}
	var t = fp_input_val + data + '#';
	fp_input.val(t);
	
	var ref_obj = $('#file_flash');
	var obj_new = $('<div></div>').css({'width':'130px','height':'130px','border':'1px solid #CCC','padding':'5px','overflow':'hidden','float':'left','margin-right':'15px','position':'relative'}).insertBefore(ref_obj)
	.append('<img src="'+data+'" onload="gresize(this)"/>');
	
	$('<a class="btn btn-danger" href="#'+data+'">X</a>')
	.css({'position':'absolute', 'bottom':'1px', 'right':'1px', 'font-size':'12px', 'padding':'3px 5px'})
	.appendTo(obj_new).bind('click',function(){
		var ci = $(this).attr('href');
		var pobj = $(this).parent().remove();
		
        var flashpic = $('#flashpic'); 
        var a=flashpic.val().replace(ci,'');
		flashpic.val(a);
	});
}

function mainPicShow(data){
	//data = $.trim(data).substring(1);
	var wrap = $('#file_img');
	wrap.children().hide();

	wrap.append('<img src="'+data+'" onload="gresize(this)"/>');
	$('#mainpic').val(data);
	
	$('<a class="btn btn-danger" href="#'+data+'">X</a>')
	.css({'position':'absolute', 'bottom':'1px', 'right':'1px', 'font-size':'12px', 'padding':'3px 5px'})
	.appendTo(wrap).bind('click',function(){
		$('#mainpic').val('');
		var pobj = $(this).parent();
		$(this).remove();
		pobj.children('img').remove();
		pobj.children().show();
	});
}

$(document).ready(function(){	
	$('.swfupload').attr('width',120).attr('height',120);
	$('.uploadify').css({'width':'130px','height':'130px','border':'1px solid #CCC','padding':'5px','overflow':'hidden'});
	$('.uploadify-button').css({'text-align':'center'});
	$('#file_img-button').css({'line-height':'120px'});
	$('#file_flash-button').css({'line-height':'60px'});
});	
</script>-->
<css href="__PUBLIC__/uploadify/uploadify.css"/>
<script>
$(document).ready(function(){
	var K = KindEditor;
	
	var uploadbutton = K.uploadbutton({
		button : K('#uploadButton22')[0],
		fieldName : 'imgFile',
		url : '{:U("site/upload")}',
		afterUpload : function(data) {
			if (data.error === 0) {
				mainPicShow(data.short_url);
			} else {
				alert(data.message);
			}
		},
		afterError : function(str) {
			alert('自定义错误信息: ' + str);
		}
	});
	uploadbutton.fileBox.change(function(e) {
		uploadbutton.submit();
	});
	K('.ke-upload-area').css({width:'100%', height:'100%'});
	
	var editor2 = K.editor({
		uploadJson : '{:U("site/upload")}',
		allowFileManager : true
	});
	K('#J_selectImage').click(function() {
		editor2.loadPlugin('multiimage', function() {
			editor2.plugin.multiImageDialog({
				clickFn : function(urlList) {
					K.each(urlList, function(i, data) {
						listPicShow(data.short_url);
					});
					editor2.hideDialog();
				}
			});
		});
	});
	
	//初始化显示图片
	<notempty name="info.picture">
		mainPicShow('/{$info.picture}');
	</notempty>
	<volist name="info.goods_gallery" id="vo">
		listPicShow('/{$vo}');
	</volist>
});

function mainPicShow(data){
	var wrap = $('#file_img');
	wrap.children().hide();
	wrap.append('<img src="'+'__UPLOAD__/'+data+'" onload="gresize(this)"/>');
	$('#mainpic').val(data);
	
	$('<a class="btn btn-danger" href="#'+data+'">X</a>')
	.css({'position':'absolute', 'bottom':'1px', 'right':'1px', 'font-size':'12px', 'padding':'3px 5px'})
	.appendTo(wrap).bind('click',function(){
		$('#mainpic').val('');
		var pobj = $(this).parent();
		$(this).remove();
		pobj.children('img').remove();
		pobj.children().show();
	});
}

function listPicShow(data){
	var fp_input = $('#flashpic');
	var fp_input_val = fp_input.val();
	if(fp_input_val.length < 1){
		fp_input_val = '#';
	}
	var t = fp_input_val + data + '#';
	fp_input.val(t);
	
	var ref_obj = $('#file_flash');
	var obj_new = $('<div></div>').css({'width':'130px','height':'130px','border':'1px solid #CCC','padding':'5px','overflow':'hidden','float':'left','margin-right':'15px','position':'relative'}).insertBefore(ref_obj)
	.append('<img src="__UPLOAD__/'+data+'" onload="gresize(this)"/>');
	
	$('<a class="btn btn-danger" href="#'+data+'">X</a>')
	.css({'position':'absolute', 'bottom':'1px', 'right':'1px', 'font-size':'12px', 'padding':'3px 5px'})
	.appendTo(obj_new).bind('click',function(){
		var ci = $(this).attr('href');
		var pobj = $(this).parent().remove();
		
        var flashpic = $('#flashpic'); 
        var a=flashpic.val().replace(ci,'');
		flashpic.val(a);
	});
}

function gresize(obj){
	var w = $(obj).width();
	var h = $(obj).height();
	if(w > h){
		$(obj).css({'height':'100%'});
	} else {
		$(obj).css({'width':'100%'});
	}
}

$(document).ready(function(){	
	$('.uploadify').css({'width':'130px','height':'130px','border':'1px solid #CCC','padding':'5px','overflow':'hidden'});
	
	//获取场景和标签
	var all_scene_list = {:json_encode($all_scene_list)};
	var all_label_list = {:json_encode($all_label_list)};
	//类型
	var all_type_list = {:json_encode($all_type_list)};
	var cat_type_list = {:json_encode($cat_type_list)};
	
	$('#cat_id').change(function(){
		var cat_id = $(this).val();
		var type_id = cat_type_list[cat_id];
		
		var scene_list = '';
		var label_list = '';
		var type_list = '';
		
		var sceneobj = all_scene_list[cat_id];
		var labelobj = all_label_list[cat_id];
		var typeobj = all_type_list[type_id];
		
		$(sceneobj).each(function(index,value){
			scene_list += '<label class="checkbox-inline"><input type="checkbox" name="scene[]" value="'+value.scene_id+'">'+value.name+'</label>';
		});
		$(labelobj).each(function(index,value){
			label_list += '<label class="checkbox-inline"><input type="checkbox" name="label[]" value="'+value.label_id+'">'+value.name+'</label>';
		});
		$(typeobj).each(function(index,value){
			type_list += '<div class="form-group"><label class="control-label col-sm-1">'+value.spec_name+'</label><div class="col-sm-4"><input name="goods_spec['+value.spec_id+']" class="input-xlarge form-control" type="text" value=""></div></div>';
		});
		
		$('#scene_list').html(scene_list);
		$('#label_list').html(label_list);
		$('#tab4').html(type_list);
	});
});
</script>

